"use strict";var _interopRequireDefault3 = require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireDefault2 = _interopRequireDefault3(require("@babel/runtime/helpers/interopRequireDefault"));Object.defineProperty(exports, "__esModule", { value: true });var _ejson = require("ejson");var EJSON = (0, _interopRequireDefault2["default"])(_ejson)["default"];

var DiffSequence = {};exports["default"] =
DiffSequence;
var hasOwn = Object.prototype.hasOwnProperty;

function isObjEmpty(obj) {
  for (var key in Object(obj)) {
    if (hasOwn.call(obj, key)) {
      return false;
    }
  }
  return true;
}

// ordered: bool.
// old_results and new_results: collections of documents.
//    if ordered, they are arrays.
//    if unordered, they are IdMaps
DiffSequence.diffQueryChanges = function (ordered, oldResults, newResults, observer, options) {
  if (ordered)
  DiffSequence.diffQueryOrderedChanges(
    oldResults, newResults, observer, options);else

  DiffSequence.diffQueryUnorderedChanges(
    oldResults, newResults, observer, options);
};

DiffSequence.diffQueryUnorderedChanges = function (oldResults, newResults, observer, options) {
  options = options || {};
  var projectionFn = options.projectionFn || EJSON.clone;

  if (observer.movedBefore) {
    throw new Error("_diffQueryUnordered called with a movedBefore observer!");
  }

  newResults.forEach(function (newDoc, id) {
    var oldDoc = oldResults.get(id);
    if (oldDoc) {
      if (observer.changed && !EJSON.equals(oldDoc, newDoc)) {
        var projectedNew = projectionFn(newDoc);
        var projectedOld = projectionFn(oldDoc);
        var changedFields = DiffSequence.makeChangedFields(projectedNew, projectedOld);
        if (!isObjEmpty(changedFields)) {
          observer.changed(id, changedFields);
        }
      }
    } else if (observer.added) {
      var fields = projectionFn(newDoc);
      delete fields._id;
      observer.added(newDoc._id, fields);
    }
  });

  if (observer.removed) {
    oldResults.forEach(function (oldDoc, id) {
      if (!newResults.has(id))
      observer.removed(id);
    });
  }
};

DiffSequence.diffQueryOrderedChanges = function (old_results, new_results, observer, options) {
  options = options || {};
  var projectionFn = options.projectionFn || EJSON.clone;

  var new_presence_of_id = {};
  new_results.forEach(function (doc) {
    new_presence_of_id[doc._id] = true;
  });

  var old_index_of_id = {};
  old_results.forEach(function (doc, i) {
    old_index_of_id[doc._id] = i;
  });

  // ALGORITHM:
  //
  // To determine which docs should be considered "moved" (and which
  // merely change position because of other docs moving) we run
  // a "longest common subsequence" (LCS) algorithm.  The LCS of the
  // old doc IDs and the new doc IDs gives the docs that should NOT be
  // considered moved.

  // To actually call the appropriate callbacks to get from the old state to the
  // new state:

  // First, we call removed() on all the items that only appear in the old
  // state.

  // Then, once we have the items that should not move, we walk through the new
  // results array group-by-group, where a "group" is a set of items that have
  // moved, anchored on the end by an item that should not move.  One by one, we
  // move each of those elements into place "before" the anchoring end-of-group
  // item, and fire changed events on them if necessary.  Then we fire a changed
  // event on the anchor, and move on to the next group.  There is always at
  // least one group; the last group is anchored by a virtual "null" id at the
  // end.

  // Asymptotically: O(N k) where k is number of ops, or potentially
  // O(N log N) if inner loop of LCS were made to be binary search.


  //////// LCS (longest common sequence, with respect to _id)
  // (see Wikipedia article on Longest Increasing Subsequence,
  // where the LIS is taken of the sequence of old indices of the
  // docs in new_results)
  //
  // unmoved: the output of the algorithm; members of the LCS,
  // in the form of indices into new_results
  var unmoved = [];
  // max_seq_len: length of LCS found so far
  var max_seq_len = 0;
  // seq_ends[i]: the index into new_results of the last doc in a
  // common subsequence of length of i+1 <= max_seq_len
  var N = new_results.length;
  var seq_ends = new Array(N);
  // ptrs:  the common subsequence ending with new_results[n] extends
  // a common subsequence ending with new_results[ptr[n]], unless
  // ptr[n] is -1.
  var ptrs = new Array(N);
  // virtual sequence of old indices of new results
  var old_idx_seq = function old_idx_seq(i_new) {
    return old_index_of_id[new_results[i_new]._id];
  };
  // for each item in new_results, use it to extend a common subsequence
  // of length j <= max_seq_len
  for (var i = 0; i < N; i++) {
    if (old_index_of_id[new_results[i]._id] !== undefined) {
      var j = max_seq_len;
      // this inner loop would traditionally be a binary search,
      // but scanning backwards we will likely find a subseq to extend
      // pretty soon, bounded for example by the total number of ops.
      // If this were to be changed to a binary search, we'd still want
      // to scan backwards a bit as an optimization.
      while (j > 0) {
        if (old_idx_seq(seq_ends[j - 1]) < old_idx_seq(i))
        break;
        j--;
      }

      ptrs[i] = j === 0 ? -1 : seq_ends[j - 1];
      seq_ends[j] = i;
      if (j + 1 > max_seq_len)
      max_seq_len = j + 1;
    }
  }

  // pull out the LCS/LIS into unmoved
  var idx = max_seq_len === 0 ? -1 : seq_ends[max_seq_len - 1];
  while (idx >= 0) {
    unmoved.push(idx);
    idx = ptrs[idx];
  }
  // the unmoved item list is built backwards, so fix that
  unmoved.reverse();

  // the last group is always anchored by the end of the result list, which is
  // an id of "null"
  unmoved.push(new_results.length);

  old_results.forEach(function (doc) {
    if (!new_presence_of_id[doc._id])
    observer.removed && observer.removed(doc._id);
  });

  // for each group of things in the new_results that is anchored by an unmoved
  // element, iterate through the things before it.
  var startOfGroup = 0;
  unmoved.forEach(function (endOfGroup) {
    var groupId = new_results[endOfGroup] ? new_results[endOfGroup]._id : null;
    var oldDoc, newDoc, fields, projectedNew, projectedOld;
    for (var i = startOfGroup; i < endOfGroup; i++) {
      newDoc = new_results[i];
      if (!hasOwn.call(old_index_of_id, newDoc._id)) {
        fields = projectionFn(newDoc);
        delete fields._id;
        observer.addedBefore && observer.addedBefore(newDoc._id, fields, groupId);
        observer.added && observer.added(newDoc._id, fields);
      } else {
        // moved
        oldDoc = old_results[old_index_of_id[newDoc._id]];
        projectedNew = projectionFn(newDoc);
        projectedOld = projectionFn(oldDoc);
        fields = DiffSequence.makeChangedFields(projectedNew, projectedOld);
        if (!isObjEmpty(fields)) {
          observer.changed && observer.changed(newDoc._id, fields);
        }
        observer.movedBefore && observer.movedBefore(newDoc._id, groupId);
      }
    }
    if (groupId) {
      newDoc = new_results[endOfGroup];
      oldDoc = old_results[old_index_of_id[newDoc._id]];
      projectedNew = projectionFn(newDoc);
      projectedOld = projectionFn(oldDoc);
      fields = DiffSequence.makeChangedFields(projectedNew, projectedOld);
      if (!isObjEmpty(fields)) {
        observer.changed && observer.changed(newDoc._id, fields);
      }
    }
    startOfGroup = endOfGroup + 1;
  });


};


// General helper for diff-ing two objects.
// callbacks is an object like so:
// { leftOnly: function (key, leftValue) {...},
//   rightOnly: function (key, rightValue) {...},
//   both: function (key, leftValue, rightValue) {...},
// }
DiffSequence.diffObjects = function (left, right, callbacks) {
  Object.keys(left).forEach(function (key) {
    var leftValue = left[key];
    if (hasOwn.call(right, key)) {
      callbacks.both && callbacks.both(key, leftValue, right[key]);
    } else {
      callbacks.leftOnly && callbacks.leftOnly(key, leftValue);
    }
  });

  if (callbacks.rightOnly) {
    Object.keys(right).forEach(function (key) {
      var rightValue = right[key];
      if (!hasOwn.call(left, key)) {
        callbacks.rightOnly(key, rightValue);
      }
    });
  }
};

DiffSequence.diffMaps = function (left, right, callbacks) {
  left.forEach(function (leftValue, key) {
    if (right.has(key)) {
      callbacks.both && callbacks.both(key, leftValue, right.get(key));
    } else {
      callbacks.leftOnly && callbacks.leftOnly(key, leftValue);
    }
  });

  if (callbacks.rightOnly) {
    right.forEach(function (rightValue, key) {
      if (!left.has(key)) {
        callbacks.rightOnly(key, rightValue);
      }
    });
  }
};


DiffSequence.makeChangedFields = function (newDoc, oldDoc) {
  var fields = {};
  DiffSequence.diffObjects(oldDoc, newDoc, {
    leftOnly: function leftOnly(key, value) {
      fields[key] = undefined;
    },
    rightOnly: function rightOnly(key, value) {
      fields[key] = value;
    },
    both: function both(key, leftValue, rightValue) {
      if (!EJSON.equals(leftValue, rightValue))
      fields[key] = rightValue;
    }
  });
  return fields;
};

DiffSequence.applyChanges = function (doc, changeFields) {
  Object.keys(changeFields).forEach(function (key) {
    var value = changeFields[key];
    if (typeof value === "undefined") {
      delete doc[key];
    } else {
      doc[key] = value;
    }
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZWpzb24iLCJyZXF1aXJlIiwiRUpTT04iLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0MiIsIkRpZmZTZXF1ZW5jZSIsImV4cG9ydHMiLCJoYXNPd24iLCJPYmplY3QiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImlzT2JqRW1wdHkiLCJvYmoiLCJrZXkiLCJjYWxsIiwiZGlmZlF1ZXJ5Q2hhbmdlcyIsIm9yZGVyZWQiLCJvbGRSZXN1bHRzIiwibmV3UmVzdWx0cyIsIm9ic2VydmVyIiwib3B0aW9ucyIsImRpZmZRdWVyeU9yZGVyZWRDaGFuZ2VzIiwiZGlmZlF1ZXJ5VW5vcmRlcmVkQ2hhbmdlcyIsInByb2plY3Rpb25GbiIsImNsb25lIiwibW92ZWRCZWZvcmUiLCJFcnJvciIsImZvckVhY2giLCJuZXdEb2MiLCJpZCIsIm9sZERvYyIsImdldCIsImNoYW5nZWQiLCJlcXVhbHMiLCJwcm9qZWN0ZWROZXciLCJwcm9qZWN0ZWRPbGQiLCJjaGFuZ2VkRmllbGRzIiwibWFrZUNoYW5nZWRGaWVsZHMiLCJhZGRlZCIsImZpZWxkcyIsIl9pZCIsInJlbW92ZWQiLCJoYXMiLCJvbGRfcmVzdWx0cyIsIm5ld19yZXN1bHRzIiwibmV3X3ByZXNlbmNlX29mX2lkIiwiZG9jIiwib2xkX2luZGV4X29mX2lkIiwiaSIsInVubW92ZWQiLCJtYXhfc2VxX2xlbiIsIk4iLCJsZW5ndGgiLCJzZXFfZW5kcyIsIkFycmF5IiwicHRycyIsIm9sZF9pZHhfc2VxIiwiaV9uZXciLCJ1bmRlZmluZWQiLCJqIiwiaWR4IiwicHVzaCIsInJldmVyc2UiLCJzdGFydE9mR3JvdXAiLCJlbmRPZkdyb3VwIiwiZ3JvdXBJZCIsImFkZGVkQmVmb3JlIiwiZGlmZk9iamVjdHMiLCJsZWZ0IiwicmlnaHQiLCJjYWxsYmFja3MiLCJrZXlzIiwibGVmdFZhbHVlIiwiYm90aCIsImxlZnRPbmx5IiwicmlnaHRPbmx5IiwicmlnaHRWYWx1ZSIsImRpZmZNYXBzIiwidmFsdWUiLCJhcHBseUNoYW5nZXMiLCJjaGFuZ2VGaWVsZHMiXSwic291cmNlcyI6WyIuLi9zcmMvRGlmZlNlcXVlbmNlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFSlNPTiBmcm9tICdlanNvbic7XG5cbmNvbnN0IERpZmZTZXF1ZW5jZSA9IHt9O1xuZXhwb3J0IGRlZmF1bHQgRGlmZlNlcXVlbmNlO1xuY29uc3QgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTtcblxuZnVuY3Rpb24gaXNPYmpFbXB0eShvYmopIHtcbiAgICBmb3IgKGxldCBrZXkgaW4gT2JqZWN0KG9iaikpIHtcbiAgICAgICAgaWYgKGhhc093bi5jYWxsKG9iaiwga2V5KSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xufVxuXG4vLyBvcmRlcmVkOiBib29sLlxuLy8gb2xkX3Jlc3VsdHMgYW5kIG5ld19yZXN1bHRzOiBjb2xsZWN0aW9ucyBvZiBkb2N1bWVudHMuXG4vLyAgICBpZiBvcmRlcmVkLCB0aGV5IGFyZSBhcnJheXMuXG4vLyAgICBpZiB1bm9yZGVyZWQsIHRoZXkgYXJlIElkTWFwc1xuRGlmZlNlcXVlbmNlLmRpZmZRdWVyeUNoYW5nZXMgPSBmdW5jdGlvbiAob3JkZXJlZCwgb2xkUmVzdWx0cywgbmV3UmVzdWx0cyxvYnNlcnZlciwgb3B0aW9ucykge1xuICAgIGlmIChvcmRlcmVkKVxuICAgICAgICBEaWZmU2VxdWVuY2UuZGlmZlF1ZXJ5T3JkZXJlZENoYW5nZXMoXG4gICAgICAgICAgICBvbGRSZXN1bHRzLCBuZXdSZXN1bHRzLCBvYnNlcnZlciwgb3B0aW9ucyk7XG4gICAgZWxzZVxuICAgICAgICBEaWZmU2VxdWVuY2UuZGlmZlF1ZXJ5VW5vcmRlcmVkQ2hhbmdlcyhcbiAgICAgICAgICAgIG9sZFJlc3VsdHMsIG5ld1Jlc3VsdHMsIG9ic2VydmVyLCBvcHRpb25zKTtcbn07XG5cbkRpZmZTZXF1ZW5jZS5kaWZmUXVlcnlVbm9yZGVyZWRDaGFuZ2VzID0gZnVuY3Rpb24gKG9sZFJlc3VsdHMsIG5ld1Jlc3VsdHMsICBvYnNlcnZlciwgb3B0aW9ucykge1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIGxldCBwcm9qZWN0aW9uRm4gPSBvcHRpb25zLnByb2plY3Rpb25GbiB8fCBFSlNPTi5jbG9uZTtcblxuICAgIGlmIChvYnNlcnZlci5tb3ZlZEJlZm9yZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJfZGlmZlF1ZXJ5VW5vcmRlcmVkIGNhbGxlZCB3aXRoIGEgbW92ZWRCZWZvcmUgb2JzZXJ2ZXIhXCIpO1xuICAgIH1cblxuICAgIG5ld1Jlc3VsdHMuZm9yRWFjaChmdW5jdGlvbiAobmV3RG9jLCBpZCkge1xuICAgICAgICBsZXQgb2xkRG9jID0gb2xkUmVzdWx0cy5nZXQoaWQpO1xuICAgICAgICBpZiAob2xkRG9jKSB7XG4gICAgICAgICAgICBpZiAob2JzZXJ2ZXIuY2hhbmdlZCAmJiAhRUpTT04uZXF1YWxzKG9sZERvYywgbmV3RG9jKSkge1xuICAgICAgICAgICAgICAgIGxldCBwcm9qZWN0ZWROZXcgPSBwcm9qZWN0aW9uRm4obmV3RG9jKTtcbiAgICAgICAgICAgICAgICBsZXQgcHJvamVjdGVkT2xkID0gcHJvamVjdGlvbkZuKG9sZERvYyk7XG4gICAgICAgICAgICAgICAgbGV0IGNoYW5nZWRGaWVsZHMgPSBEaWZmU2VxdWVuY2UubWFrZUNoYW5nZWRGaWVsZHMocHJvamVjdGVkTmV3LCBwcm9qZWN0ZWRPbGQpO1xuICAgICAgICAgICAgICAgIGlmICghIGlzT2JqRW1wdHkoY2hhbmdlZEZpZWxkcykpIHtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY2hhbmdlZChpZCwgY2hhbmdlZEZpZWxkcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKG9ic2VydmVyLmFkZGVkKSB7XG4gICAgICAgICAgICB2YXIgZmllbGRzID0gcHJvamVjdGlvbkZuKG5ld0RvYyk7XG4gICAgICAgICAgICBkZWxldGUgZmllbGRzLl9pZDtcbiAgICAgICAgICAgIG9ic2VydmVyLmFkZGVkKG5ld0RvYy5faWQsIGZpZWxkcyk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChvYnNlcnZlci5yZW1vdmVkKSB7XG4gICAgICAgIG9sZFJlc3VsdHMuZm9yRWFjaChmdW5jdGlvbiAob2xkRG9jLCBpZCkge1xuICAgICAgICAgICAgaWYgKCFuZXdSZXN1bHRzLmhhcyhpZCkpXG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIucmVtb3ZlZChpZCk7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5cbkRpZmZTZXF1ZW5jZS5kaWZmUXVlcnlPcmRlcmVkQ2hhbmdlcyA9IGZ1bmN0aW9uIChvbGRfcmVzdWx0cywgbmV3X3Jlc3VsdHMsIG9ic2VydmVyLCBvcHRpb25zKSB7XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgbGV0IHByb2plY3Rpb25GbiA9IG9wdGlvbnMucHJvamVjdGlvbkZuIHx8IEVKU09OLmNsb25lO1xuXG4gICAgbGV0IG5ld19wcmVzZW5jZV9vZl9pZCA9IHt9O1xuICAgIG5ld19yZXN1bHRzLmZvckVhY2goZnVuY3Rpb24gKGRvYykge1xuICAgICAgICBuZXdfcHJlc2VuY2Vfb2ZfaWRbZG9jLl9pZF0gPSB0cnVlO1xuICAgIH0pO1xuXG4gICAgbGV0IG9sZF9pbmRleF9vZl9pZCA9IHt9O1xuICAgIG9sZF9yZXN1bHRzLmZvckVhY2goZnVuY3Rpb24gKGRvYywgaSkge1xuICAgICAgICBvbGRfaW5kZXhfb2ZfaWRbZG9jLl9pZF0gPSBpO1xuICAgIH0pO1xuXG4gICAgLy8gQUxHT1JJVEhNOlxuICAgIC8vXG4gICAgLy8gVG8gZGV0ZXJtaW5lIHdoaWNoIGRvY3Mgc2hvdWxkIGJlIGNvbnNpZGVyZWQgXCJtb3ZlZFwiIChhbmQgd2hpY2hcbiAgICAvLyBtZXJlbHkgY2hhbmdlIHBvc2l0aW9uIGJlY2F1c2Ugb2Ygb3RoZXIgZG9jcyBtb3ZpbmcpIHdlIHJ1blxuICAgIC8vIGEgXCJsb25nZXN0IGNvbW1vbiBzdWJzZXF1ZW5jZVwiIChMQ1MpIGFsZ29yaXRobS4gIFRoZSBMQ1Mgb2YgdGhlXG4gICAgLy8gb2xkIGRvYyBJRHMgYW5kIHRoZSBuZXcgZG9jIElEcyBnaXZlcyB0aGUgZG9jcyB0aGF0IHNob3VsZCBOT1QgYmVcbiAgICAvLyBjb25zaWRlcmVkIG1vdmVkLlxuXG4gICAgLy8gVG8gYWN0dWFsbHkgY2FsbCB0aGUgYXBwcm9wcmlhdGUgY2FsbGJhY2tzIHRvIGdldCBmcm9tIHRoZSBvbGQgc3RhdGUgdG8gdGhlXG4gICAgLy8gbmV3IHN0YXRlOlxuXG4gICAgLy8gRmlyc3QsIHdlIGNhbGwgcmVtb3ZlZCgpIG9uIGFsbCB0aGUgaXRlbXMgdGhhdCBvbmx5IGFwcGVhciBpbiB0aGUgb2xkXG4gICAgLy8gc3RhdGUuXG5cbiAgICAvLyBUaGVuLCBvbmNlIHdlIGhhdmUgdGhlIGl0ZW1zIHRoYXQgc2hvdWxkIG5vdCBtb3ZlLCB3ZSB3YWxrIHRocm91Z2ggdGhlIG5ld1xuICAgIC8vIHJlc3VsdHMgYXJyYXkgZ3JvdXAtYnktZ3JvdXAsIHdoZXJlIGEgXCJncm91cFwiIGlzIGEgc2V0IG9mIGl0ZW1zIHRoYXQgaGF2ZVxuICAgIC8vIG1vdmVkLCBhbmNob3JlZCBvbiB0aGUgZW5kIGJ5IGFuIGl0ZW0gdGhhdCBzaG91bGQgbm90IG1vdmUuICBPbmUgYnkgb25lLCB3ZVxuICAgIC8vIG1vdmUgZWFjaCBvZiB0aG9zZSBlbGVtZW50cyBpbnRvIHBsYWNlIFwiYmVmb3JlXCIgdGhlIGFuY2hvcmluZyBlbmQtb2YtZ3JvdXBcbiAgICAvLyBpdGVtLCBhbmQgZmlyZSBjaGFuZ2VkIGV2ZW50cyBvbiB0aGVtIGlmIG5lY2Vzc2FyeS4gIFRoZW4gd2UgZmlyZSBhIGNoYW5nZWRcbiAgICAvLyBldmVudCBvbiB0aGUgYW5jaG9yLCBhbmQgbW92ZSBvbiB0byB0aGUgbmV4dCBncm91cC4gIFRoZXJlIGlzIGFsd2F5cyBhdFxuICAgIC8vIGxlYXN0IG9uZSBncm91cDsgdGhlIGxhc3QgZ3JvdXAgaXMgYW5jaG9yZWQgYnkgYSB2aXJ0dWFsIFwibnVsbFwiIGlkIGF0IHRoZVxuICAgIC8vIGVuZC5cblxuICAgIC8vIEFzeW1wdG90aWNhbGx5OiBPKE4gaykgd2hlcmUgayBpcyBudW1iZXIgb2Ygb3BzLCBvciBwb3RlbnRpYWxseVxuICAgIC8vIE8oTiBsb2cgTikgaWYgaW5uZXIgbG9vcCBvZiBMQ1Mgd2VyZSBtYWRlIHRvIGJlIGJpbmFyeSBzZWFyY2guXG5cblxuICAgIC8vLy8vLy8vIExDUyAobG9uZ2VzdCBjb21tb24gc2VxdWVuY2UsIHdpdGggcmVzcGVjdCB0byBfaWQpXG4gICAgLy8gKHNlZSBXaWtpcGVkaWEgYXJ0aWNsZSBvbiBMb25nZXN0IEluY3JlYXNpbmcgU3Vic2VxdWVuY2UsXG4gICAgLy8gd2hlcmUgdGhlIExJUyBpcyB0YWtlbiBvZiB0aGUgc2VxdWVuY2Ugb2Ygb2xkIGluZGljZXMgb2YgdGhlXG4gICAgLy8gZG9jcyBpbiBuZXdfcmVzdWx0cylcbiAgICAvL1xuICAgIC8vIHVubW92ZWQ6IHRoZSBvdXRwdXQgb2YgdGhlIGFsZ29yaXRobTsgbWVtYmVycyBvZiB0aGUgTENTLFxuICAgIC8vIGluIHRoZSBmb3JtIG9mIGluZGljZXMgaW50byBuZXdfcmVzdWx0c1xuICAgIHZhciB1bm1vdmVkID0gW107XG4gICAgLy8gbWF4X3NlcV9sZW46IGxlbmd0aCBvZiBMQ1MgZm91bmQgc28gZmFyXG4gICAgdmFyIG1heF9zZXFfbGVuID0gMDtcbiAgICAvLyBzZXFfZW5kc1tpXTogdGhlIGluZGV4IGludG8gbmV3X3Jlc3VsdHMgb2YgdGhlIGxhc3QgZG9jIGluIGFcbiAgICAvLyBjb21tb24gc3Vic2VxdWVuY2Ugb2YgbGVuZ3RoIG9mIGkrMSA8PSBtYXhfc2VxX2xlblxuICAgIHZhciBOID0gbmV3X3Jlc3VsdHMubGVuZ3RoO1xuICAgIHZhciBzZXFfZW5kcyA9IG5ldyBBcnJheShOKTtcbiAgICAvLyBwdHJzOiAgdGhlIGNvbW1vbiBzdWJzZXF1ZW5jZSBlbmRpbmcgd2l0aCBuZXdfcmVzdWx0c1tuXSBleHRlbmRzXG4gICAgLy8gYSBjb21tb24gc3Vic2VxdWVuY2UgZW5kaW5nIHdpdGggbmV3X3Jlc3VsdHNbcHRyW25dXSwgdW5sZXNzXG4gICAgLy8gcHRyW25dIGlzIC0xLlxuICAgIHZhciBwdHJzID0gbmV3IEFycmF5KE4pO1xuICAgIC8vIHZpcnR1YWwgc2VxdWVuY2Ugb2Ygb2xkIGluZGljZXMgb2YgbmV3IHJlc3VsdHNcbiAgICB2YXIgb2xkX2lkeF9zZXEgPSBmdW5jdGlvbihpX25ldykge1xuICAgICAgICByZXR1cm4gb2xkX2luZGV4X29mX2lkW25ld19yZXN1bHRzW2lfbmV3XS5faWRdO1xuICAgIH07XG4gICAgLy8gZm9yIGVhY2ggaXRlbSBpbiBuZXdfcmVzdWx0cywgdXNlIGl0IHRvIGV4dGVuZCBhIGNvbW1vbiBzdWJzZXF1ZW5jZVxuICAgIC8vIG9mIGxlbmd0aCBqIDw9IG1heF9zZXFfbGVuXG4gICAgZm9yKHZhciBpPTA7IGk8TjsgaSsrKSB7XG4gICAgICAgIGlmIChvbGRfaW5kZXhfb2ZfaWRbbmV3X3Jlc3VsdHNbaV0uX2lkXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB2YXIgaiA9IG1heF9zZXFfbGVuO1xuICAgICAgICAgICAgLy8gdGhpcyBpbm5lciBsb29wIHdvdWxkIHRyYWRpdGlvbmFsbHkgYmUgYSBiaW5hcnkgc2VhcmNoLFxuICAgICAgICAgICAgLy8gYnV0IHNjYW5uaW5nIGJhY2t3YXJkcyB3ZSB3aWxsIGxpa2VseSBmaW5kIGEgc3Vic2VxIHRvIGV4dGVuZFxuICAgICAgICAgICAgLy8gcHJldHR5IHNvb24sIGJvdW5kZWQgZm9yIGV4YW1wbGUgYnkgdGhlIHRvdGFsIG51bWJlciBvZiBvcHMuXG4gICAgICAgICAgICAvLyBJZiB0aGlzIHdlcmUgdG8gYmUgY2hhbmdlZCB0byBhIGJpbmFyeSBzZWFyY2gsIHdlJ2Qgc3RpbGwgd2FudFxuICAgICAgICAgICAgLy8gdG8gc2NhbiBiYWNrd2FyZHMgYSBiaXQgYXMgYW4gb3B0aW1pemF0aW9uLlxuICAgICAgICAgICAgd2hpbGUgKGogPiAwKSB7XG4gICAgICAgICAgICAgICAgaWYgKG9sZF9pZHhfc2VxKHNlcV9lbmRzW2otMV0pIDwgb2xkX2lkeF9zZXEoaSkpXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGotLTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcHRyc1tpXSA9IChqID09PSAwID8gLTEgOiBzZXFfZW5kc1tqLTFdKTtcbiAgICAgICAgICAgIHNlcV9lbmRzW2pdID0gaTtcbiAgICAgICAgICAgIGlmIChqKzEgPiBtYXhfc2VxX2xlbilcbiAgICAgICAgICAgICAgICBtYXhfc2VxX2xlbiA9IGorMTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIHB1bGwgb3V0IHRoZSBMQ1MvTElTIGludG8gdW5tb3ZlZFxuICAgIHZhciBpZHggPSAobWF4X3NlcV9sZW4gPT09IDAgPyAtMSA6IHNlcV9lbmRzW21heF9zZXFfbGVuLTFdKTtcbiAgICB3aGlsZSAoaWR4ID49IDApIHtcbiAgICAgICAgdW5tb3ZlZC5wdXNoKGlkeCk7XG4gICAgICAgIGlkeCA9IHB0cnNbaWR4XTtcbiAgICB9XG4gICAgLy8gdGhlIHVubW92ZWQgaXRlbSBsaXN0IGlzIGJ1aWx0IGJhY2t3YXJkcywgc28gZml4IHRoYXRcbiAgICB1bm1vdmVkLnJldmVyc2UoKTtcblxuICAgIC8vIHRoZSBsYXN0IGdyb3VwIGlzIGFsd2F5cyBhbmNob3JlZCBieSB0aGUgZW5kIG9mIHRoZSByZXN1bHQgbGlzdCwgd2hpY2ggaXNcbiAgICAvLyBhbiBpZCBvZiBcIm51bGxcIlxuICAgIHVubW92ZWQucHVzaChuZXdfcmVzdWx0cy5sZW5ndGgpO1xuXG4gICAgb2xkX3Jlc3VsdHMuZm9yRWFjaChmdW5jdGlvbiAoZG9jKSB7XG4gICAgICAgIGlmICghbmV3X3ByZXNlbmNlX29mX2lkW2RvYy5faWRdKVxuICAgICAgICAgICAgb2JzZXJ2ZXIucmVtb3ZlZCAmJiBvYnNlcnZlci5yZW1vdmVkKGRvYy5faWQpO1xuICAgIH0pO1xuXG4gICAgLy8gZm9yIGVhY2ggZ3JvdXAgb2YgdGhpbmdzIGluIHRoZSBuZXdfcmVzdWx0cyB0aGF0IGlzIGFuY2hvcmVkIGJ5IGFuIHVubW92ZWRcbiAgICAvLyBlbGVtZW50LCBpdGVyYXRlIHRocm91Z2ggdGhlIHRoaW5ncyBiZWZvcmUgaXQuXG4gICAgdmFyIHN0YXJ0T2ZHcm91cCA9IDA7XG4gICAgdW5tb3ZlZC5mb3JFYWNoKGZ1bmN0aW9uIChlbmRPZkdyb3VwKSB7XG4gICAgICAgIHZhciBncm91cElkID0gbmV3X3Jlc3VsdHNbZW5kT2ZHcm91cF0gPyBuZXdfcmVzdWx0c1tlbmRPZkdyb3VwXS5faWQgOiBudWxsO1xuICAgICAgICB2YXIgb2xkRG9jLCBuZXdEb2MsIGZpZWxkcywgcHJvamVjdGVkTmV3LCBwcm9qZWN0ZWRPbGQ7XG4gICAgICAgIGZvciAodmFyIGkgPSBzdGFydE9mR3JvdXA7IGkgPCBlbmRPZkdyb3VwOyBpKyspIHtcbiAgICAgICAgICAgIG5ld0RvYyA9IG5ld19yZXN1bHRzW2ldO1xuICAgICAgICAgICAgaWYgKCFoYXNPd24uY2FsbChvbGRfaW5kZXhfb2ZfaWQsIG5ld0RvYy5faWQpKSB7XG4gICAgICAgICAgICAgICAgZmllbGRzID0gcHJvamVjdGlvbkZuKG5ld0RvYyk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGZpZWxkcy5faWQ7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuYWRkZWRCZWZvcmUgJiYgb2JzZXJ2ZXIuYWRkZWRCZWZvcmUobmV3RG9jLl9pZCwgZmllbGRzLCBncm91cElkKTtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5hZGRlZCAmJiBvYnNlcnZlci5hZGRlZChuZXdEb2MuX2lkLCBmaWVsZHMpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBtb3ZlZFxuICAgICAgICAgICAgICAgIG9sZERvYyA9IG9sZF9yZXN1bHRzW29sZF9pbmRleF9vZl9pZFtuZXdEb2MuX2lkXV07XG4gICAgICAgICAgICAgICAgcHJvamVjdGVkTmV3ID0gcHJvamVjdGlvbkZuKG5ld0RvYyk7XG4gICAgICAgICAgICAgICAgcHJvamVjdGVkT2xkID0gcHJvamVjdGlvbkZuKG9sZERvYyk7XG4gICAgICAgICAgICAgICAgZmllbGRzID0gRGlmZlNlcXVlbmNlLm1ha2VDaGFuZ2VkRmllbGRzKHByb2plY3RlZE5ldywgcHJvamVjdGVkT2xkKTtcbiAgICAgICAgICAgICAgICBpZiAoIWlzT2JqRW1wdHkoZmllbGRzKSkge1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jaGFuZ2VkICYmIG9ic2VydmVyLmNoYW5nZWQobmV3RG9jLl9pZCwgZmllbGRzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubW92ZWRCZWZvcmUgJiYgb2JzZXJ2ZXIubW92ZWRCZWZvcmUobmV3RG9jLl9pZCwgZ3JvdXBJZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGdyb3VwSWQpIHtcbiAgICAgICAgICAgIG5ld0RvYyA9IG5ld19yZXN1bHRzW2VuZE9mR3JvdXBdO1xuICAgICAgICAgICAgb2xkRG9jID0gb2xkX3Jlc3VsdHNbb2xkX2luZGV4X29mX2lkW25ld0RvYy5faWRdXTtcbiAgICAgICAgICAgIHByb2plY3RlZE5ldyA9IHByb2plY3Rpb25GbihuZXdEb2MpO1xuICAgICAgICAgICAgcHJvamVjdGVkT2xkID0gcHJvamVjdGlvbkZuKG9sZERvYyk7XG4gICAgICAgICAgICBmaWVsZHMgPSBEaWZmU2VxdWVuY2UubWFrZUNoYW5nZWRGaWVsZHMocHJvamVjdGVkTmV3LCBwcm9qZWN0ZWRPbGQpO1xuICAgICAgICAgICAgaWYgKCFpc09iakVtcHR5KGZpZWxkcykpIHtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5jaGFuZ2VkICYmIG9ic2VydmVyLmNoYW5nZWQobmV3RG9jLl9pZCwgZmllbGRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBzdGFydE9mR3JvdXAgPSBlbmRPZkdyb3VwKzE7XG4gICAgfSk7XG5cblxufTtcblxuXG4vLyBHZW5lcmFsIGhlbHBlciBmb3IgZGlmZi1pbmcgdHdvIG9iamVjdHMuXG4vLyBjYWxsYmFja3MgaXMgYW4gb2JqZWN0IGxpa2Ugc286XG4vLyB7IGxlZnRPbmx5OiBmdW5jdGlvbiAoa2V5LCBsZWZ0VmFsdWUpIHsuLi59LFxuLy8gICByaWdodE9ubHk6IGZ1bmN0aW9uIChrZXksIHJpZ2h0VmFsdWUpIHsuLi59LFxuLy8gICBib3RoOiBmdW5jdGlvbiAoa2V5LCBsZWZ0VmFsdWUsIHJpZ2h0VmFsdWUpIHsuLi59LFxuLy8gfVxuRGlmZlNlcXVlbmNlLmRpZmZPYmplY3RzID0gZnVuY3Rpb24gKGxlZnQsIHJpZ2h0LCBjYWxsYmFja3MpIHtcbiAgICBPYmplY3Qua2V5cyhsZWZ0KS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgIGNvbnN0IGxlZnRWYWx1ZSA9IGxlZnRba2V5XTtcbiAgICAgICAgaWYgKGhhc093bi5jYWxsKHJpZ2h0LCBrZXkpKSB7XG4gICAgICAgICAgICBjYWxsYmFja3MuYm90aCAmJiBjYWxsYmFja3MuYm90aChrZXksIGxlZnRWYWx1ZSwgcmlnaHRba2V5XSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjYWxsYmFja3MubGVmdE9ubHkgJiYgY2FsbGJhY2tzLmxlZnRPbmx5KGtleSwgbGVmdFZhbHVlKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKGNhbGxiYWNrcy5yaWdodE9ubHkpIHtcbiAgICAgICAgT2JqZWN0LmtleXMocmlnaHQpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJpZ2h0VmFsdWUgPSByaWdodFtrZXldO1xuICAgICAgICAgICAgaWYgKCEgaGFzT3duLmNhbGwobGVmdCwga2V5KSkge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5yaWdodE9ubHkoa2V5LCByaWdodFZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufTtcblxuRGlmZlNlcXVlbmNlLmRpZmZNYXBzID0gZnVuY3Rpb24gKGxlZnQsIHJpZ2h0LCBjYWxsYmFja3MpIHtcbiAgICBsZWZ0LmZvckVhY2goZnVuY3Rpb24gKGxlZnRWYWx1ZSwga2V5KSB7XG4gICAgICAgIGlmIChyaWdodC5oYXMoa2V5KSl7XG4gICAgICAgICAgICBjYWxsYmFja3MuYm90aCAmJiBjYWxsYmFja3MuYm90aChrZXksIGxlZnRWYWx1ZSwgcmlnaHQuZ2V0KGtleSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY2FsbGJhY2tzLmxlZnRPbmx5ICYmIGNhbGxiYWNrcy5sZWZ0T25seShrZXksIGxlZnRWYWx1ZSk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChjYWxsYmFja3MucmlnaHRPbmx5KSB7XG4gICAgICAgIHJpZ2h0LmZvckVhY2goZnVuY3Rpb24gKHJpZ2h0VmFsdWUsIGtleSkge1xuICAgICAgICAgICAgaWYgKCFsZWZ0LmhhcyhrZXkpKXtcbiAgICAgICAgICAgICAgICBjYWxsYmFja3MucmlnaHRPbmx5KGtleSwgcmlnaHRWYWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5cblxuRGlmZlNlcXVlbmNlLm1ha2VDaGFuZ2VkRmllbGRzID0gZnVuY3Rpb24gKG5ld0RvYywgb2xkRG9jKSB7XG4gICAgdmFyIGZpZWxkcyA9IHt9O1xuICAgIERpZmZTZXF1ZW5jZS5kaWZmT2JqZWN0cyhvbGREb2MsIG5ld0RvYywge1xuICAgICAgICBsZWZ0T25seTogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHtcbiAgICAgICAgICAgIGZpZWxkc1trZXldID0gdW5kZWZpbmVkO1xuICAgICAgICB9LFxuICAgICAgICByaWdodE9ubHk6IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7XG4gICAgICAgICAgICBmaWVsZHNba2V5XSA9IHZhbHVlO1xuICAgICAgICB9LFxuICAgICAgICBib3RoOiBmdW5jdGlvbiAoa2V5LCBsZWZ0VmFsdWUsIHJpZ2h0VmFsdWUpIHtcbiAgICAgICAgICAgIGlmICghRUpTT04uZXF1YWxzKGxlZnRWYWx1ZSwgcmlnaHRWYWx1ZSkpXG4gICAgICAgICAgICAgICAgZmllbGRzW2tleV0gPSByaWdodFZhbHVlO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGZpZWxkcztcbn07XG5cbkRpZmZTZXF1ZW5jZS5hcHBseUNoYW5nZXMgPSBmdW5jdGlvbiAoZG9jLCBjaGFuZ2VGaWVsZHMpIHtcbiAgICBPYmplY3Qua2V5cyhjaGFuZ2VGaWVsZHMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBjaGFuZ2VGaWVsZHNba2V5XTtcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICAgICAgZGVsZXRlIGRvY1trZXldO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZG9jW2tleV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgIH0pO1xufTtcbiJdLCJtYXBwaW5ncyI6ImdSQUFBLElBQUFBLE1BQUEsR0FBQUMsT0FBQSxVQUEwQixJQUFuQkMsS0FBSyxPQUFBQyx1QkFBQSxhQUFBSCxNQUFBOztBQUVaLElBQU1JLFlBQVksR0FBRyxDQUFDLENBQUMsQ0FBQ0MsT0FBQTtBQUNURCxZQUFZO0FBQzNCLElBQU1FLE1BQU0sR0FBR0MsTUFBTSxDQUFDQyxTQUFTLENBQUNDLGNBQWM7O0FBRTlDLFNBQVNDLFVBQVVBLENBQUNDLEdBQUcsRUFBRTtFQUNyQixLQUFLLElBQUlDLEdBQUcsSUFBSUwsTUFBTSxDQUFDSSxHQUFHLENBQUMsRUFBRTtJQUN6QixJQUFJTCxNQUFNLENBQUNPLElBQUksQ0FBQ0YsR0FBRyxFQUFFQyxHQUFHLENBQUMsRUFBRTtNQUN2QixP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