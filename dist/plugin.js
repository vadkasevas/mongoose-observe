"use strict";var _interopRequireDefault3 = require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireDefault2 = _interopRequireDefault3(require("@babel/runtime/helpers/interopRequireDefault"));Object.defineProperty(exports, "__esModule", { value: true });var _regenerator = require("@babel/runtime/regenerator");var _regeneratorRuntime = (0, _interopRequireDefault2["default"])(_regenerator)["default"];var _asyncToGenerator2 = require("@babel/runtime/helpers/asyncToGenerator");var _asyncToGenerator = (0, _interopRequireDefault2["default"])(_asyncToGenerator2)["default"];exports["default"] =
































































observeChangesPlugin;var _ObserveLogs = require("./ObserveLogs");var ObserveLogs = (0, _interopRequireDefault2["default"])(_ObserveLogs)["default"];var _ObserveCursor = require("./ObserveCursor");var ObserveCursor = (0, _interopRequireDefault2["default"])(_ObserveCursor)["default"];var _mongoose = require("mongoose");var Query = _mongoose.Query;var _ejson = require("ejson");var EJSON = (0, _interopRequireDefault2["default"])(_ejson)["default"];var _emitter = require("./emitter");var emitter = (0, _interopRequireDefault2["default"])(_emitter)["default"];var _ObserveCursorDeep = require("./ObserveCursorDeep");var ObserveCursorDeep = (0, _interopRequireDefault2["default"])(_ObserveCursorDeep)["default"];var mongoose = require('mongoose');var moduleMongoose = require.cache[require.resolve('mongoose')];var bson = moduleMongoose.require('bson');var mongodb = moduleMongoose.require('mongodb');var isReady = false;emitter.on('ready', function () {isReady = true;});emitter.on('notready', function () {isReady = false;});function waitReady() {return _waitReady.apply(this, arguments);}function _waitReady() {_waitReady = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {return _regeneratorRuntime.wrap(function _callee5$(_context5) {while (1) {switch (_context5.prev = _context5.next) {case 0:if (!isReady) {_context5.next = 2;break;}return _context5.abrupt("return", Promise.resolve());case 2:return _context5.abrupt("return", new Promise(function (resolve) {emitter.once('ready', resolve);}));case 3:case "end":return _context5.stop();}}}, _callee5);}));return _waitReady.apply(this, arguments);}var BsonObjectId = bson.ObjectID;var MongodbObjectId = mongodb.ObjectId; /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * @returns {ObserveCursor}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         * */Query.prototype.observeChanges = function (handlers, options) {return new ObserveCursor(this, options).observeChanges(handlers);}; /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * @returns {ObserveCursor}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * */Query.prototype.observeDeepChanges = function (handlers, options) {return new ObserveCursorDeep(this, options).observeChanges(handlers);};mongoose.ObjectId.prototype.toJSONValue = BsonObjectId.prototype.toJSONValue = MongodbObjectId.prototype.toJSONValue = function () {return this.toString();};MongodbObjectId.prototype.typeName = mongoose.ObjectId.prototype.typeName = BsonObjectId.prototype.typeName = function () {return 'ObjectID';};EJSON.addType('ObjectID', function fromJSONValue(json) {return json;});function collectionName(ctx) {var result = null;if (ctx instanceof mongoose.Model) {result = ctx.collection.name;} else if (ctx instanceof mongoose.Query) {result = ctx.mongooseCollection.name;}return result;}function observeChangesPlugin(schema, options) {/*schema.pre('save',function(){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       //console.log(this);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return Promise.resolve();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   });*/schema.post('save', /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {var rawDoc;return _regeneratorRuntime.wrap(function _callee$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:_context.next = 2;return waitReady();case 2:rawDoc = this.toObject({ getters: true });
            rawDoc = EJSON.clone(rawDoc);
            new ObserveLogs({
              type: 'save',
              collectionName: collectionName(this),
              arguments: [rawDoc],
              state: {
                isNew: this.isNew },

              date: new Date() }).
            save();case 5:case "end":return _context.stop();}}}, _callee, this);})));


  schema.post(/^remove|Remove/, { query: true, document: true }, /*#__PURE__*/function () {var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(result) {var condition;return _regeneratorRuntime.wrap(function _callee2$(_context2) {while (1) {switch (_context2.prev = _context2.next) {case 0:_context2.next = 2;return (
                waitReady());case 2:
              //let rawDoc = this.toObject({ getters: false });
              //rawDoc = EJSON.clone(rawDoc);
              condition = null;
              if (result instanceof mongoose.Model) {
                condition = EJSON.clone({ _id: result._id });
              } else if (this instanceof mongoose.Query && result.deletedCount > 0) {
                condition = EJSON.clone(this._conditions);
              }

              if (condition) {
                new ObserveLogs({
                  type: 'remove',
                  collectionName: collectionName(this),
                  arguments: [condition],
                  state: {},
                  date: new Date() }).
                save();
              }case 5:case "end":return _context2.stop();}}}, _callee2, this);}));return function (_x) {return _ref2.apply(this, arguments);};}());


  schema.post(/^update|Update/, { query: true, document: true }, /*#__PURE__*/function () {var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(result) {var condition;return _regeneratorRuntime.wrap(function _callee3$(_context3) {while (1) {switch (_context3.prev = _context3.next) {case 0:_context3.next = 2;return (

                waitReady());case 2:
              condition = null;
              if (result instanceof mongoose.Model) {
                condition = EJSON.clone({ _id: result._id });
              } else if (this instanceof mongoose.Query && result.nModified > 0) {
                condition = EJSON.clone(this._conditions);
              }
              if (condition) {
                new ObserveLogs({
                  type: 'update',
                  collectionName: collectionName(this),
                  arguments: [condition],
                  state: {},
                  date: new Date() }).
                save();
              }case 5:case "end":return _context3.stop();}}}, _callee3, this);}));return function (_x2) {return _ref3.apply(this, arguments);};}());


  schema.post(/^delete|Delete/, { query: true, document: true }, /*#__PURE__*/function () {var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(result) {var condition;return _regeneratorRuntime.wrap(function _callee4$(_context4) {while (1) {switch (_context4.prev = _context4.next) {case 0:_context4.next = 2;return (

                waitReady());case 2:
              condition = null;
              if (result instanceof mongoose.Model) {
                condition = EJSON.clone({ _id: result._id });
              } else if (this instanceof mongoose.Query && result.deletedCount > 0) {
                condition = EJSON.clone(this._conditions);
              }

              if (condition) {
                new ObserveLogs({
                  type: 'remove',
                  collectionName: collectionName(this),
                  arguments: [condition],
                  state: {},
                  date: new Date() }).
                save();
              }case 5:case "end":return _context4.stop();}}}, _callee4, this);}));return function (_x3) {return _ref4.apply(this, arguments);};}());



}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wbHVnaW4uanMiXSwibmFtZXMiOlsib2JzZXJ2ZUNoYW5nZXNQbHVnaW4iLCJPYnNlcnZlTG9ncyIsIk9ic2VydmVDdXJzb3IiLCJRdWVyeSIsIkVKU09OIiwiZW1pdHRlciIsIk9ic2VydmVDdXJzb3JEZWVwIiwibW9uZ29vc2UiLCJyZXF1aXJlIiwibW9kdWxlTW9uZ29vc2UiLCJjYWNoZSIsInJlc29sdmUiLCJic29uIiwibW9uZ29kYiIsImlzUmVhZHkiLCJvbiIsIndhaXRSZWFkeSIsIlByb21pc2UiLCJvbmNlIiwiQnNvbk9iamVjdElkIiwiT2JqZWN0SUQiLCJNb25nb2RiT2JqZWN0SWQiLCJPYmplY3RJZCIsInByb3RvdHlwZSIsIm9ic2VydmVDaGFuZ2VzIiwiaGFuZGxlcnMiLCJvcHRpb25zIiwib2JzZXJ2ZURlZXBDaGFuZ2VzIiwidG9KU09OVmFsdWUiLCJ0b1N0cmluZyIsInR5cGVOYW1lIiwiYWRkVHlwZSIsImZyb21KU09OVmFsdWUiLCJqc29uIiwiY29sbGVjdGlvbk5hbWUiLCJjdHgiLCJyZXN1bHQiLCJNb2RlbCIsImNvbGxlY3Rpb24iLCJuYW1lIiwibW9uZ29vc2VDb2xsZWN0aW9uIiwic2NoZW1hIiwicG9zdCIsInJhd0RvYyIsInRvT2JqZWN0IiwiZ2V0dGVycyIsImNsb25lIiwidHlwZSIsImFyZ3VtZW50cyIsInN0YXRlIiwiaXNOZXciLCJkYXRlIiwiRGF0ZSIsInNhdmUiLCJxdWVyeSIsImRvY3VtZW50IiwiY29uZGl0aW9uIiwiX2lkIiwiZGVsZXRlZENvdW50IiwiX2NvbmRpdGlvbnMiLCJuTW9kaWZpZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUV3QkEsb0IsQ0FqRXhCLDRDLElBQU9DLFcsb0VBQ1AsZ0QsSUFBT0MsYSxzRUFDUCxvQyxJQUFRQyxLLGFBQUFBLEssQ0FDUiw4QixJQUFPQyxLLDhE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RUFBNUQ7Ozs7QUFzQkgiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT2JzZXJ2ZUxvZ3MgZnJvbSBcIi4vT2JzZXJ2ZUxvZ3NcIjtcbmltcG9ydCBPYnNlcnZlQ3Vyc29yIGZyb20gXCIuL09ic2VydmVDdXJzb3JcIjtcbmltcG9ydCB7UXVlcnl9IGZyb20gJ21vbmdvb3NlJztcbmltcG9ydCBFSlNPTiBmcm9tICdlanNvbic7XG5jb25zdCBtb25nb29zZSA9IHJlcXVpcmUoJ21vbmdvb3NlJyk7XG5pbXBvcnQgZW1pdHRlciBmcm9tIFwiLi9lbWl0dGVyXCI7XG5pbXBvcnQgT2JzZXJ2ZUN1cnNvckRlZXAgZnJvbSBcIi4vT2JzZXJ2ZUN1cnNvckRlZXBcIjtcblxuY29uc3QgbW9kdWxlTW9uZ29vc2UgPSByZXF1aXJlLmNhY2hlW3JlcXVpcmUucmVzb2x2ZSgnbW9uZ29vc2UnKV1cblxuY29uc3QgYnNvbiA9IG1vZHVsZU1vbmdvb3NlLnJlcXVpcmUoJ2Jzb24nKTtcbmNvbnN0IG1vbmdvZGIgPSBtb2R1bGVNb25nb29zZS5yZXF1aXJlKCdtb25nb2RiJyk7XG5cbmxldCBpc1JlYWR5ID0gZmFsc2U7XG5lbWl0dGVyLm9uKCdyZWFkeScsKCk9PntcbiAgICBpc1JlYWR5ID0gdHJ1ZTtcbn0pO1xuZW1pdHRlci5vbignbm90cmVhZHknLCgpPT57XG4gICAgaXNSZWFkeSA9IGZhbHNlO1xufSk7XG5cbmFzeW5jIGZ1bmN0aW9uIHdhaXRSZWFkeSgpe1xuICAgIGlmKGlzUmVhZHkpXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpPT57XG4gICAgICAgIGVtaXR0ZXIub25jZSgncmVhZHknLHJlc29sdmUpO1xuICAgIH0pO1xufVxuXG5jb25zdCBCc29uT2JqZWN0SWQgPSBic29uLk9iamVjdElEO1xuY29uc3QgTW9uZ29kYk9iamVjdElkID0gbW9uZ29kYi5PYmplY3RJZDtcblxuLyoqXG4gKiBAcmV0dXJucyB7T2JzZXJ2ZUN1cnNvcn1cbiAqICovXG5RdWVyeS5wcm90b3R5cGUub2JzZXJ2ZUNoYW5nZXMgPSBmdW5jdGlvbihoYW5kbGVycyxvcHRpb25zKXtcbiAgICByZXR1cm4gbmV3IE9ic2VydmVDdXJzb3IodGhpcyxvcHRpb25zKS5vYnNlcnZlQ2hhbmdlcyhoYW5kbGVycyk7XG59O1xuXG4vKipcbiAqIEByZXR1cm5zIHtPYnNlcnZlQ3Vyc29yfVxuICogKi9cblF1ZXJ5LnByb3RvdHlwZS5vYnNlcnZlRGVlcENoYW5nZXMgPSBmdW5jdGlvbihoYW5kbGVycyxvcHRpb25zKXtcbiAgICByZXR1cm4gbmV3IE9ic2VydmVDdXJzb3JEZWVwKHRoaXMsb3B0aW9ucykub2JzZXJ2ZUNoYW5nZXMoaGFuZGxlcnMpO1xufTtcblxubW9uZ29vc2UuT2JqZWN0SWQucHJvdG90eXBlLnRvSlNPTlZhbHVlID0gQnNvbk9iamVjdElkLnByb3RvdHlwZS50b0pTT05WYWx1ZSA9IE1vbmdvZGJPYmplY3RJZC5wcm90b3R5cGUudG9KU09OVmFsdWUgPSBmdW5jdGlvbigpe1xuICAgIHJldHVybiB0aGlzLnRvU3RyaW5nKCk7XG59O1xuTW9uZ29kYk9iamVjdElkLnByb3RvdHlwZS50eXBlTmFtZT1tb25nb29zZS5PYmplY3RJZC5wcm90b3R5cGUudHlwZU5hbWUgPUJzb25PYmplY3RJZC5wcm90b3R5cGUudHlwZU5hbWUgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gJ09iamVjdElEJztcbn07XG5FSlNPTi5hZGRUeXBlKCdPYmplY3RJRCcsIGZ1bmN0aW9uIGZyb21KU09OVmFsdWUoanNvbikge1xuICAgIHJldHVybiBqc29uO1xufSk7XG5cbmZ1bmN0aW9uIGNvbGxlY3Rpb25OYW1lKGN0eCl7XG4gICAgbGV0IHJlc3VsdCA9IG51bGw7XG4gICAgaWYoY3R4IGluc3RhbmNlb2YgbW9uZ29vc2UuTW9kZWwpe1xuICAgICAgICByZXN1bHQgPSBjdHguY29sbGVjdGlvbi5uYW1lO1xuICAgIH1lbHNlIGlmKGN0eCBpbnN0YW5jZW9mIG1vbmdvb3NlLlF1ZXJ5KXtcbiAgICAgICAgcmVzdWx0ID0gY3R4Lm1vbmdvb3NlQ29sbGVjdGlvbi5uYW1lO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xufVxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gb2JzZXJ2ZUNoYW5nZXNQbHVnaW4oc2NoZW1hLCBvcHRpb25zKSB7XG4gICAgLypzY2hlbWEucHJlKCdzYXZlJyxmdW5jdGlvbigpe1xuICAgICAgICAvL2NvbnNvbGUubG9nKHRoaXMpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfSk7Ki9cbiAgICBzY2hlbWEucG9zdCgnc2F2ZScsYXN5bmMgZnVuY3Rpb24oKXtcbiAgICAgICAgYXdhaXQgd2FpdFJlYWR5KCk7XG4gICAgICAgIGxldCByYXdEb2MgPSB0aGlzLnRvT2JqZWN0KHsgZ2V0dGVyczogdHJ1ZSB9KTtcbiAgICAgICAgcmF3RG9jID0gRUpTT04uY2xvbmUocmF3RG9jKTtcbiAgICAgICAgbmV3IE9ic2VydmVMb2dzKHtcbiAgICAgICAgICAgIHR5cGU6J3NhdmUnLFxuICAgICAgICAgICAgY29sbGVjdGlvbk5hbWU6Y29sbGVjdGlvbk5hbWUodGhpcyksXG4gICAgICAgICAgICBhcmd1bWVudHM6W3Jhd0RvY10sXG4gICAgICAgICAgICBzdGF0ZTp7XG4gICAgICAgICAgICAgICAgaXNOZXc6dGhpcy5pc05ld1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRhdGU6bmV3IERhdGUoKVxuICAgICAgICB9KS5zYXZlKCk7XG4gICAgfSk7XG5cbiAgICBzY2hlbWEucG9zdCgvXnJlbW92ZXxSZW1vdmUvLCB7IHF1ZXJ5OiB0cnVlLGRvY3VtZW50OnRydWUgIH0sYXN5bmMgZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgIGF3YWl0IHdhaXRSZWFkeSgpO1xuICAgICAgICAvL2xldCByYXdEb2MgPSB0aGlzLnRvT2JqZWN0KHsgZ2V0dGVyczogZmFsc2UgfSk7XG4gICAgICAgIC8vcmF3RG9jID0gRUpTT04uY2xvbmUocmF3RG9jKTtcbiAgICAgICAgbGV0IGNvbmRpdGlvbiA9IG51bGw7XG4gICAgICAgIGlmKHJlc3VsdCBpbnN0YW5jZW9mIG1vbmdvb3NlLk1vZGVsKXtcbiAgICAgICAgICAgIGNvbmRpdGlvbiA9RUpTT04uY2xvbmUoe19pZDpyZXN1bHQuX2lkfSk7XG4gICAgICAgIH1lbHNlIGlmKHRoaXMgaW5zdGFuY2VvZiBtb25nb29zZS5RdWVyeSAmJiByZXN1bHQuZGVsZXRlZENvdW50PjApe1xuICAgICAgICAgICAgY29uZGl0aW9uID0gRUpTT04uY2xvbmUodGhpcy5fY29uZGl0aW9ucyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZihjb25kaXRpb24pIHtcbiAgICAgICAgICAgIG5ldyBPYnNlcnZlTG9ncyh7XG4gICAgICAgICAgICAgICAgdHlwZTogJ3JlbW92ZScsXG4gICAgICAgICAgICAgICAgY29sbGVjdGlvbk5hbWU6Y29sbGVjdGlvbk5hbWUodGhpcyksXG4gICAgICAgICAgICAgICAgYXJndW1lbnRzOiBbY29uZGl0aW9uXSxcbiAgICAgICAgICAgICAgICBzdGF0ZToge30sXG4gICAgICAgICAgICAgICAgZGF0ZTogbmV3IERhdGUoKVxuICAgICAgICAgICAgfSkuc2F2ZSgpO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBzY2hlbWEucG9zdCgvXnVwZGF0ZXxVcGRhdGUvLCB7IHF1ZXJ5OiB0cnVlLGRvY3VtZW50OnRydWUgfSxhc3luYyBmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgLy9jb25zb2xlLmxvZyh7cmVzdWx0fSk7XG4gICAgICAgIGF3YWl0IHdhaXRSZWFkeSgpO1xuICAgICAgICBsZXQgY29uZGl0aW9uID0gbnVsbDtcbiAgICAgICAgaWYocmVzdWx0IGluc3RhbmNlb2YgbW9uZ29vc2UuTW9kZWwpe1xuICAgICAgICAgICAgY29uZGl0aW9uID0gRUpTT04uY2xvbmUoe19pZDpyZXN1bHQuX2lkfSk7XG4gICAgICAgIH1lbHNlIGlmKHRoaXMgaW5zdGFuY2VvZiBtb25nb29zZS5RdWVyeSAmJiByZXN1bHQubk1vZGlmaWVkPjApe1xuICAgICAgICAgICAgY29uZGl0aW9uID0gRUpTT04uY2xvbmUodGhpcy5fY29uZGl0aW9ucyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYoY29uZGl0aW9uKSB7XG4gICAgICAgICAgICBuZXcgT2JzZXJ2ZUxvZ3Moe1xuICAgICAgICAgICAgICAgIHR5cGU6ICd1cGRhdGUnLFxuICAgICAgICAgICAgICAgIGNvbGxlY3Rpb25OYW1lOmNvbGxlY3Rpb25OYW1lKHRoaXMpLFxuICAgICAgICAgICAgICAgIGFyZ3VtZW50czogW2NvbmRpdGlvbl0sXG4gICAgICAgICAgICAgICAgc3RhdGU6IHt9LFxuICAgICAgICAgICAgICAgIGRhdGU6IG5ldyBEYXRlKClcbiAgICAgICAgICAgIH0pLnNhdmUoKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgc2NoZW1hLnBvc3QoL15kZWxldGV8RGVsZXRlLywgeyBxdWVyeTogdHJ1ZSxkb2N1bWVudDp0cnVlIH0sYXN5bmMgZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgIC8vY29uc29sZS5sb2coe3Jlc3VsdH0pO1xuICAgICAgICBhd2FpdCB3YWl0UmVhZHkoKTtcbiAgICAgICAgbGV0IGNvbmRpdGlvbiA9IG51bGw7XG4gICAgICAgIGlmKHJlc3VsdCBpbnN0YW5jZW9mIG1vbmdvb3NlLk1vZGVsKXtcbiAgICAgICAgICAgIGNvbmRpdGlvbiA9IEVKU09OLmNsb25lKHtfaWQ6cmVzdWx0Ll9pZH0pO1xuICAgICAgICB9ZWxzZSBpZih0aGlzIGluc3RhbmNlb2YgbW9uZ29vc2UuUXVlcnkgJiYgcmVzdWx0LmRlbGV0ZWRDb3VudD4wKXtcbiAgICAgICAgICAgIGNvbmRpdGlvbiA9IEVKU09OLmNsb25lKHRoaXMuX2NvbmRpdGlvbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYoY29uZGl0aW9uKSB7XG4gICAgICAgICAgICBuZXcgT2JzZXJ2ZUxvZ3Moe1xuICAgICAgICAgICAgICAgIHR5cGU6ICdyZW1vdmUnLFxuICAgICAgICAgICAgICAgIGNvbGxlY3Rpb25OYW1lOmNvbGxlY3Rpb25OYW1lKHRoaXMpLFxuICAgICAgICAgICAgICAgIGFyZ3VtZW50czogW2NvbmRpdGlvbl0sXG4gICAgICAgICAgICAgICAgc3RhdGU6IHt9LFxuICAgICAgICAgICAgICAgIGRhdGU6IG5ldyBEYXRlKClcbiAgICAgICAgICAgIH0pLnNhdmUoKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG5cbn0iXX0=